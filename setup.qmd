---
title: "Setup"
filters:
  - highlight-text
format: 
  html: default
  pdf: default
---

This work takes NM CTFM profiles, resamples them and calculates the number of
flight present per hour, `H`, of date, `D` in H3 hexagonal cells
(at resolution `R`) covering the EUROCONTROL Member's airspace.

R scripts are in the `R/` directory.

You need duckdb 1.2.2 with `icu` extension and `h3` community extension
installed (extension location hardcoded in `aviodebris::hexagonize`).

We use the following values:

* H3 hexagons at resolution `R = 3`: 
  - Average Area (km2): `12393.43`
  - Average edge length (Km): `68.98`
* bounding box approximating EUROCONTROL Area (decimal degrees) in the
  `aviodebris` packages (enclosing FIRs of Member States)


::: {#fig-cells}

```{r cells-map}
#| out-width: "100%"
#| echo: false
knitr::include_graphics("media/figures/cells_3.png")
```

H3 **[cells]{colour="#ff0000"}** ([red]{colour="#ffffff" bg-colour="#ff0000"})
at resolution 3 and
their **[centers]{colour="#0000ff"}** ([blue]{colour="#ffffff" bg-colour="#0000ff"}) covering EUROCONTROL Area (([blue]{colour="#ffffff" bg-colour="#0000ff"}) polygon).

:::


## Data Preparation

### Data Extraction
We first extract data for data `D` (for example `2024-08-01`)
1. flight list for date `D`
1. point profile for flown trajectories, i.e. M3/CTFM for date `D`
   in the correct bounding box.
   We use `point_profiles_tidy()` from the `{eurocontrol}` package

This is achieved via script `export_data.R`.
The relevant trajectories are saved in `data-raw/trjs/trjs_{D}.parquet`,
i.e. `data-raw/trjs/trjs_2024-08-01.parquet`.

### Trajectory Resampling
We load the trajectories and resample them at 30s using helper function in the
`aviodebris` package, 10min per day.  
The result is in 
`data/trajectories_2024-08-01_resampled_30s.parquet`

### Fast H3 Labelling
The `hexagonize` function in `aviodebris` uses DuckDB (plus ICU extension
and H3 community extension) for fast labelling
of each lon/lat to the relevant H3 cell (at resolution `R`)
and filtering for samples within EUROCONTROL bbox.
Keep only point in the hex cells of the bbox and for day `D`.
The result is saved in `trajectories_<YYYY-MM-DD>_resampled_30s_bbox_res_<R>.parquet` for date `D`.



## Cell Occupancy and Density

The function `traffic_density_hourly` in the package `aviodebris` calculates
the occupancy per hour `H` of `D` for each cell at resolution `R`.
A file for each day is saved as
`traffic_density_<YYYY-MM-DD>_res_<R>_hourly.parquet` for date `D`.
The results are summarised per aircraft type.

## Collision and Casuality Risk
The function `collision_and_casuality_risk_expectation_hourly`
calculates both collision and casuality risk on a hourly basis.
